# System Design для социальной сети для путешественников. Поток 13

## Функциональные требование

- Возможность публиковать посты с прикреплением фотографий, текста с описанием
  - Просмотр собственной ленты
- Возможность ставить гео метки на посты
- Лента с публикациями от отслеживаемых путешественников
  - Записи в обратном хронологическом порядке
- Система оценки и комментариев для постов
- Система поиска постов по геометкам
- Система рекомендаций популярный мест по запросу

## Нефункциональные требования

- DAU 10.000.000 (первый год, дальше линейный рост)
- Аудитория СНГ
- Высокая надежность системы:
  - Доступность в год около 99.999%
  - Данные клиентов не могут теряться/повреждаться (необходимо иметь бэкапы, реплики данных, надежную доставку)
- Для пользователя должен грузиться быстро (из требований удобства):
  - Подгрузка контента в ленте + комменты (в размере экрана, но не более 10) не более ~300 ms (с учетом хорошего интернета)
  - Регистрация лайков на пост мгновенная
  - Публикация комментов мгновенная
  - Отображение новых комментов под постом не более 2с с момента публикации
  - Поиск по геометкам не более 1с
  - Загрузка контента пользователем (1 пост) на сервера (с учетом хорошего интернета) в рамках до ~1 мин
  - После загрузки контента пользователем, подписчики должны увидеть пост в ленте не позже ~10с (собственную публикацию не более 1с)
- Публикации не удаляются со временем из хранилища
- Платформы: web, ios, android
- Учет популярных аккаунтов (тех у кого много подписчиков)
- Сезонность: Весна, лето
- Типы активностей:
  - нет ограничений на кол-во просмотров постов в ленте (get запросы), возьмем в среднем 50 в день (?)
  - ожидается в среднем, 10 публикаций раз в 3е суток от пользователя (1 пост = 1 медиа файл + небольшой текст)
  - лайки, комментарии ~ кол-ву просмотренных публикаций
- Есть возможность сжимать фото

## Расчет примерной нагрузки

- Публикация
  - RPS = 10.000.000 / 3 / 86.400 ~ 385
  - Traffic (media) = 385 * 1mb (avg_image_size) = 385 mb/s
  - Traffic (text) = 385 * 100kb (avg_text_size) = 385000kb ~ 31 mb/s
  - Traffic (geo mark/other meta) = 385 * 5kb = 1725kb ~ 17 mb/s

- Просмотр ленты
  - RPS = 10.000.000 * 50 / 86.400 ~ 5787
  - Traffic (media) = 5787 * 1mb (avg_image_size) = 5787mb ~ 5.787.000kb ~ 5gb/s
  - Traffic (text) = 5787 * 100kb (avg_text_size) = 578.700kb ~ 578мb/s
  - Traffic (reactions) (тк в требованиях нет реации на комменты , то считаем только на посты в медиане) =
  5787 * 500b = 2600000b ~ 2,6 mb/s
  - Traffic (meta data) = 5787 * 50kb = 260000kb ~ 260mb/s

Connections = 10.000.000 * 0.1 = 1.000.000

## Оценка дисков

#### Референсные характеристики
|    | HDD|SSD (SATA)| SSD (nVME)|
|-----|------|-------------|-------------|
|Объем|до 32ТБ|до 100ТБ|до 30ТБ|
|Операции ввода-вывода в секунду|100|1 000|10 00|
|Пропускная способность|100 МБ/с|500 МБ/с|3 ГБ/с|

#### Формулы

Disks_for_capacity = capacity / disk_capacity<br>
Disks_for_throughput = traffic_per_second / disk_throughput<br>
Disks_for_iops = iops / disk_iops<br>
Disks = max(ceil(Disks_for_capacity), ceil(Disks_for_throughput), ceil(Disks_for_iops))

>Где:
>**disk_capacity** - объем одного диска <br>
>**capacity** - суммарный объем данных, которое необходимо хранить <br>
>**traffic_per_second** - суммарный трафик на запись/чтение в секунду <br>
>**disk_throughput** - пропускная способность одного диска <br>
>**iops** - суммарное количество запросов в секунду <br>
>**disk_iops** - количество операций ввода-вывод диска в секунду <br>
>**ceil** - функция округления вверх до целого числа <br>

<b><i>На первый год хранения сравним дешевую и среднюю конфигурации:</i></b><br>
<b>HDD:</b><br>
1.Медиа
>capacity = 385 МБ/c * 86400 * 365 *0.5 (с учетом сжатия данных) = 6Пб <br>
>Disks_for_capacity = 6000ТБ / 32ТБ = 187,5 <br>
>Disks_for_throughput = 385 МБ/c (из расчета трафика) / 100 МБ/c = 3.85 <br>
>Disks_for_iops = 385 / 100 = 3.85 <br>
>Disks = max (ceil(3.85), ceil(3.85) , ceil(187,5)) = <b>187 шт</b> 

2.Текст
>capacity = 31 МБ/c * 86400 * 365 = 977Тб <br>
>Disks_for_capacity = 977ТБ / 32ТБ = 30 <br>
>Disks_for_throughput = 31 МБ/c (из расчета трафика) / 100 МБ/c = 0.31 <br>
>Disks_for_iops = 385 / 100 = 3.85 <br>
>Disks = max (ceil(3.85), ceil(0.31) , ceil(30)) = <b>30 шт</b> 

3. Мета
>capacity = 17 МБ/c * 86400 * 365 = 536ТБ <br>
>Disks_for_capacity = 536ТБ / 32ТБ = 16.75 <br>
>Disks_for_throughput = 17 МБ/c (из расчета трафика) / 100 МБ/c = 0.17 <br>
>Disks_for_iops = 385 / 100 = 3.85 <br>
>Disks = max (ceil(3.85), ceil(0.17) , ceil(16.75)) = <b>17 шт</b>

4. Реакции
>capacity = 0.5 МБ/c * 86400 * 365 = 15.8ТБ <br>
>Disks_for_capacity = 15.8ТБ / 32ТБ = 0.49 <br>
>Disks_for_throughput = 0.5 МБ/c (из расчета трафика) / 100 МБ/c = 0.02 <br>
>Disks_for_iops = 385 / 100 = 3.85 <br>
>Disks = max (ceil(0.49), ceil(3.85) , ceil(0.02)) = <b>4 шт</b>

<b>SSD:</b><br>
1.Медиа
>capacity = 385 МБ/c * 86400 * 365 *0.5 (с учетом сжатия данных) = 6Пб <br>
>Disks_for_capacity = 6000ТБ / 90ТБ = 66 <br>
>Disks_for_throughput = 385 МБ/c (из расчета трафика) / 500 МБ/c = 0.77 <br>
>Disks_for_iops = 385 / 1000 = 0.385 <br>
>Disks = max (ceil(0.385), ceil(66) , ceil(0.77)) = <b>66 шт</b>

2.Текст
>capacity = 31 МБ/c * 86400 * 365 = 977Тб <br>
>Disks_for_capacity = 977ТБ / 90ТБ = 10 <br>
>Disks_for_throughput = 31 МБ/c (из расчета трафика) / 500 МБ/c = 0.06 <br>
>Disks_for_iops = 385 / 1000 = 3.85 <br>
>Disks = max (ceil(3.85), ceil(0.31) , ceil(30)) = <b>10 шт</b>

3. Мета
>capacity = 17 МБ/c * 86400 * 365 = 536ТБ <br>
>Disks_for_capacity = 536ТБ / 90ТБ = 10.9 <br>
>Disks_for_throughput = 17 МБ/c (из расчета трафика) / 500 МБ/c = 0.034 <br>
>Disks_for_iops = 385 / 1000 = 0.385 <br>
>Disks = max (ceil(0.385), ceil(0.034) , ceil(10.9)) = <b>11 шт</b>

4. Реакции
>capacity = 0.5 МБ/c * 86400 * 365 = 15.8ТБ <br>
>Disks_for_capacity = 15.8ТБ / 20ТБ (берем малообъемный) = 0.8 <br>
>Disks_for_throughput = 0.5 МБ/c (из расчета трафика) / 500 МБ/c = 0.001 <br>
>Disks_for_iops = 385 / 1000 = 0.385 <br>
>Disks = max (ceil(0.385), ceil(0.001) , ceil(0.8)) = <b>1 шт</b>

Итого: <b>Исходя из расчетов для отдельных типов данных итог следующий: media - SSD; реакции - HDD; мета - HDD; текст - в целом можно тоже взять SSD с заделом на будущее</b>
