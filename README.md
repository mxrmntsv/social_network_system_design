# System Design для социальной сети для путешественников. Поток 13

## Функциональные требование

- Возможность публиковать посты с прикреплением фотографий, текста с описанием
  - Просмотр собственной ленты
- Возможность ставить гео метки на посты
- Лента с публикациями от отслеживаемых путешественников
  - Записи в обратном хронологическом порядке
- Система оценки и комментариев для постов
- Система поиска постов по геометкам
- Система рекомендаций популярный мест по запросу

## Нефункциональные требования

- DAU 10.000.000 (первый год, дальше линейный рост)
- Аудитория СНГ
- Высокая надежность системы:
  - Доступность в год около 99.999%
  - Данные клиентов не могут теряться/повреждаться (необходимо иметь бэкапы, реплики данных, надежную доставку)
- Для пользователя должен грузиться быстро (из требований удобства):
  - Подгрузка контента в ленте + комменты (в размере экрана, но не более 10) не более ~300 ms (с учетом хорошего интернета)
  - Регистрация лайков на пост мгновенная
  - Публикация комментов мгновенная
  - Отображение новых комментов под постом не более 2с с момента публикации
  - Поиск по геометкам не более 1с
  - Загрузка контента пользователем (1 пост) на сервера (с учетом хорошего интернета) в рамках до ~1 мин
  - После загрузки контента пользователем, подписчики должны увидеть пост в ленте не позже ~10с (собственную публикацию не более 1с)
- Публикации не удаляются со временем из хранилища
- Платформы: web, ios, android
- Учет популярных аккаунтов (тех у кого много подписчиков)
- Сезонность: Весна, лето
- Типы активностей:
  - нет ограничений на кол-во просмотров постов в ленте (get запросы), возьмем в среднем 50 в день (?)
  - ожидается в среднем, 10 публикаций раз в 3е суток от пользователя (1 пост = 1 медиа файл + небольшой текст)
  - лайки, комментарии ~ кол-ву просмотренных публикаций
- Есть возможность сжимать фото

## Расчет примерной нагрузки

- Публикация
  - RPS = 10.000.000 / 3 / 86.400 ~ 38.5
  - Traffic (media) = 38.5 * 1mb (avg_image_size) = 38.5 mb/s
  - Traffic (text) = 38.5 * 100kb (avg_text_size) = 38.500kb ~ 3.85 mb/s
  - Traffic (geo mark/other meta) = 38.5 * 5kb = 1725kb ~ 1,7 mb/s

- Просмотр ленты
  - RPS = 10.000.000 * 50 / 86.400 ~ 5787
  - Traffic (media) = 5787 * 1mb (avg_image_size) = 5787mb ~ 5.787.000kb ~ 5gb/s
  - Traffic (text) = 5787 * 100kb (avg_text_size) = 578.700kb ~ 578мb/s
  - Traffic (reactions) (тк в требованиях нет реации на комменты , то считаем только на посты в медиане) =
  5787 * 500b = 2600000b ~ 2,6 mb/s
  - Traffic (meta data) = 5787 * 50kb = 260000kb ~ 260mb/s

Connections = 10.000.000 * 0.1 = 1.000.000

## Оценка дисков

#### Референсные характеристики
|    | HDD|SSD (SATA)| SSD (nVME)|
|-----|------|-------------|-------------|
|Объем|до 32ТБ|до 100ТБ|до 30ТБ|
|Операции ввода-вывода в секунду|100|1 000|10 00|
|Пропускная способность|100 МБ/с|500 МБ/с|3 ГБ/с|

#### Формулы

Disks_for_capacity = capacity / disk_capacity<br>
Disks_for_throughput = traffic_per_second / disk_throughput<br>
Disks_for_iops = iops / disk_iops<br>
Disks = max(ceil(Disks_for_capacity), ceil(Disks_for_throughput), ceil(Disks_for_iops))

>Где:
>**disk_capacity** - объем одного диска <br>
>**capacity** - суммарный объем данных, которое необходимо хранить <br>
>**traffic_per_second** - суммарный трафик на запись/чтение в секунду <br>
>**disk_throughput** - пропускная способность одного диска <br>
>**iops** - суммарное количество запросов в секунду <br>
>**disk_iops** - количество операций ввода-вывод диска в секунду <br>
>**ceil** - функция округления вверх до целого числа <br>

<b><i>На первый год хранения сравним дешевую и среднюю конфигурации:</i></b><br>
<b>HDD:</b><br>
1.Медиа
>capacity = 2314 МБ/c * 86400 * 365 *0.6 (с учетом сжатия данных) = 43Пб <br>
>Disks_for_capacity = 43000ТБ / 32ТБ = 1100 <br>
>Disks_for_throughput = 2314 МБ/c (из расчета трафика) / 500 МБ/c = 40 <br>
>Disks_for_iops = 2314 / 100 = 23 <br>
>Disks = max (ceil(40), ceil(23) , ceil(1100)) = <b>1100 шт</b>

2.Текст + Мета + реакции
>capacity = 900 МБ/c * 86400 * 365 = 25Пб <br>
>Disks_for_capacity = 25000ТБ / 32ТБ = 781 <br>
>Disks_for_throughput = 900 МБ/c (из расчета трафика) / 100 МБ/c = 9 <br>
>Disks_for_iops = 5787 / 100 = 58 <br>
>Disks = max (ceil(53), ceil(51) , ceil(781)) = <b>781 шт</b>

<b>SSD:</b><br>
1.Медиа
>capacity = 2314 МБ/c * 86400 * 365 *0.6 (с учетом сжатия данных) = 43Пб <br>
>Disks_for_capacity = 43000ТБ / 90ТБ = 477.7 <br>
>Disks_for_throughput = 2314 МБ/c (из расчета трафика) / 500 МБ/c = 4 <br>
>Disks_for_iops = 2314 / 1000 = 2.3 <br>
>Disks = max (ceil(4), ceil(2.3) , ceil(477.7)) = <b>478 шт</b>

2.Текст + Мета + реакции
>capacity = 900 МБ/c * 86400 * 365 = 25Пб <br>
>Disks_for_capacity = 25000ТБ / 90ТБ = 277 <br>
>Disks_for_throughput = 900 МБ/c (из расчета трафика) / 500 МБ/c = 4.5 <br>
>Disks_for_iops = 5787 / 1000 = 5.8 <br>
>Disks = max (ceil(4.5), ceil(277) , ceil(5.8)) = <b>277 шт</b>

Итого: <b>исходя из расчетов выгоднее брать SSD</b>
